*&---------------------------------------------------------------------*
*& Include          ZFIVENDCD_SCR
*&---------------------------------------------------------------------*
*& Screen Events
*&---------------------------------------------------------------------*

*&---------------------------------------------------------------------*
*& Form fetch_data
*&---------------------------------------------------------------------*
*& Fetch data from BSIK table
*&---------------------------------------------------------------------*
FORM fetch_data.

  " Local data declarations
  DATA: lt_bsik_temp TYPE STANDARD TABLE OF bsik,
        ls_bsik_temp TYPE bsik,
        ls_bkpf      TYPE bkpf,
        ls_bseg      TYPE bseg,
        lv_orig_blart TYPE bkpf-blart,
        lv_vendor_name TYPE lfa1-name1,
        lv_mandi      TYPE zp2pttruck-zp2pdemandi,
        lv_payment_reason TYPE bseg-rstgr,
        lv_days       TYPE i,
        lv_payment_due_date TYPE bsik-zfbdt.

  " Select data from BSIK (Vendor Open Items)
  SELECT bukrs lifnr gjahr belnr buzei budat bldat gsber waers
         wrbtr skfbt zfbdt rebzg rebzj rebzz shkzg blart zterm
         zbd1t zbd2t zbd3t zbd1p zbd2p augdt
    FROM bsik
    INTO TABLE lt_bsik_temp
    WHERE bukrs IN s_bukrs
      AND lifnr IN s_zp2pde     "Corrected: Using correct vendor range
      AND budat IN s_budat
      AND shkzg = 'H'           "Credit indicator
      AND blart IN ('RE', 'KR', 'AB').  "Invoice, Credit Memo, Down Payment

  IF sy-subrc = 0.
    LOOP AT lt_bsik_temp INTO ls_bsik_temp.

      CLEAR: lv_orig_blart, lv_vendor_name, lv_mandi, lv_payment_reason,
             lv_days, lv_payment_due_date.

      " Special handling for AB (Down Payment) documents
      IF ls_bsik_temp-blart = 'AB'.
        " Fetch original document type from BKPF
        SELECT SINGLE blart
          FROM bkpf
          INTO lv_orig_blart
          WHERE bukrs = ls_bsik_temp-bukrs
            AND belnr = ls_bsik_temp-rebzg
            AND gjahr = ls_bsik_temp-rebzj.

        " Skip if original document is not RE or KR
        IF sy-subrc <> 0 OR ( lv_orig_blart <> 'RE' AND lv_orig_blart <> 'KR' ).
          CONTINUE.
        ENDIF.
      ENDIF.

      " Fetch vendor name from LFA1
      SELECT SINGLE name1
        FROM lfa1
        INTO lv_vendor_name
        WHERE lifnr = ls_bsik_temp-lifnr.

      " Fetch Mandi from ZP2PTTRUCK
      SELECT SINGLE zp2pdemandi
        FROM zp2pttruck
        INTO lv_mandi
        WHERE zp2pdepa = ls_bsik_temp-lifnr.

      " Fetch Payment Reason Code from BSEG
      SELECT SINGLE rstgr
        FROM bseg
        INTO lv_payment_reason
        WHERE bukrs = ls_bsik_temp-bukrs
          AND belnr = ls_bsik_temp-belnr
          AND gjahr = ls_bsik_temp-gjahr
          AND buzei = ls_bsik_temp-buzei.

      " Calculate Payment Due Date using payment term hierarchy
      " Priority: ZBD3T > ZBD2T > ZBD1T
      IF ls_bsik_temp-zbd3t IS NOT INITIAL.
        lv_payment_due_date = ls_bsik_temp-zfbdt + ls_bsik_temp-zbd3t.
      ELSEIF ls_bsik_temp-zbd2t IS NOT INITIAL.
        lv_payment_due_date = ls_bsik_temp-zfbdt + ls_bsik_temp-zbd2t.
      ELSEIF ls_bsik_temp-zbd1t IS NOT INITIAL.
        lv_payment_due_date = ls_bsik_temp-zfbdt + ls_bsik_temp-zbd1t.
      ELSE.
        lv_payment_due_date = ls_bsik_temp-zfbdt.
      ENDIF.

      " Calculate number of days
      lv_days = sy-datum - ls_bsik_temp-zfbdt.

      " Build internal table
      CLEAR gs_credit.
      
      " Initialize checkboxes
      gs_credit-checkmark    = ''.
      gs_credit-manual_edit  = ''.
      
      " Payment Details
      gs_credit-payment_reason = lv_payment_reason.
      gs_credit-payment_term = ls_bsik_temp-zterm.
      
      " Basic Document Info
      gs_credit-bukrs        = ls_bsik_temp-bukrs.
      gs_credit-zp2pdemandi  = lv_mandi.
      gs_credit-lifnr        = ls_bsik_temp-lifnr.
      gs_credit-vendor_name  = lv_vendor_name.
      gs_credit-gjahr        = ls_bsik_temp-gjahr.
      gs_credit-belnr        = ls_bsik_temp-belnr.
      gs_credit-buzei        = ls_bsik_temp-buzei.
      gs_credit-budat        = ls_bsik_temp-budat.
      gs_credit-bldat        = ls_bsik_temp-bldat.
      gs_credit-gsber        = ls_bsik_temp-gsber.
      gs_credit-waers        = ls_bsik_temp-waers.
      
      " Amount Fields
      gs_credit-wrbtr        = ls_bsik_temp-wrbtr.
      gs_credit-skfbt        = ls_bsik_temp-skfbt.
      gs_credit-payment_amt  = ls_bsik_temp-wrbtr.  "Payment Amount = Document Amount
      
      " Cash Discount Levels
      gs_credit-cd_level1_days = ls_bsik_temp-zbd1t.
      gs_credit-cd_level1_pct  = ls_bsik_temp-zbd1p.
      gs_credit-cd_level2_days = ls_bsik_temp-zbd2t.
      gs_credit-cd_level2_pct  = ls_bsik_temp-zbd2p.
      
      " Date Fields
      gs_credit-zfbdt        = ls_bsik_temp-zfbdt.
      gs_credit-payment_due_date = lv_payment_due_date.
      gs_credit-payment_date = ls_bsik_temp-augdt.
      gs_credit-zfbdt_days   = lv_days.
      
      " Calculate Applicable CD % and Amount
      PERFORM calculate_applicable_cd USING ls_bsik_temp-zfbdt
                                            ls_bsik_temp-zbd1t
                                            ls_bsik_temp-zbd2t
                                            ls_bsik_temp-zbd1p
                                            ls_bsik_temp-zbd2p
                                            ls_bsik_temp-wrbtr
                                            lv_payment_due_date
                                      CHANGING gs_credit-applicable_cd_pct
                                              gs_credit-applicable_cd_amt.
      
      " Reference Fields
      gs_credit-rebzg        = ls_bsik_temp-rebzg.
      gs_credit-rebzj        = ls_bsik_temp-rebzj.
      gs_credit-rebzz        = ls_bsik_temp-rebzz.
      gs_credit-debit_note_no = ls_bsik_temp-rebzg.  "Using reference doc as debit note

      APPEND gs_credit TO gt_credit.

    ENDLOOP.
  ENDIF.

  " Display message if no data found
  IF gt_credit IS INITIAL.
    MESSAGE 'No data found for the given selection criteria' TYPE 'I'.
  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form calculate_applicable_cd
*&---------------------------------------------------------------------*
*& Calculate applicable cash discount percentage and amount
*&---------------------------------------------------------------------*
FORM calculate_applicable_cd USING p_zfbdt TYPE bsik-zfbdt
                                   p_zbd1t TYPE bsik-zbd1t
                                   p_zbd2t TYPE bsik-zbd2t
                                   p_zbd1p TYPE bsik-zbd1p
                                   p_zbd2p TYPE bsik-zbd2p
                                   p_amount TYPE bsik-wrbtr
                                   p_due_date TYPE bsik-zfbdt
                             CHANGING p_cd_pct TYPE p
                                     p_cd_amt TYPE bsik-wrbtr.

  DATA: lv_days TYPE i,
        lv_cd_level1_date TYPE sy-datum,
        lv_cd_level2_date TYPE sy-datum.

  " Calculate days from baseline date
  lv_days = sy-datum - p_zfbdt.

  " Calculate CD level dates
  lv_cd_level1_date = p_zfbdt + p_zbd1t.
  lv_cd_level2_date = p_zfbdt + p_zbd2t.

  " Determine applicable CD percentage
  IF sy-datum <= lv_cd_level1_date AND p_zbd1p IS NOT INITIAL.
    " Within CD Level 1 period
    p_cd_pct = ( lv_days * p_zbd1p ) / 365.
  ELSEIF sy-datum > lv_cd_level1_date AND
         sy-datum <= lv_cd_level2_date AND
         p_zbd2p IS NOT INITIAL.
    " Within CD Level 2 period
    p_cd_pct = ( lv_days * p_zbd2p ) / 365.
  ELSE.
    " Beyond all CD periods
    p_cd_pct = 0.
  ENDIF.

  " Calculate applicable CD amount
  IF p_cd_pct > 0.
    p_cd_amt = ( p_amount * p_cd_pct ) / 100.
  ELSE.
    p_cd_amt = 0.
  ENDIF.

ENDFORM.
